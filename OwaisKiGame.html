<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Racing Game</title>
    <link rel="stylesheet" href="styles.css">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // Custom hook for game loop
        const useGameLoop = (callback, delay) => {
            const callbackRef = useRef(callback);
            const timeoutRef = useRef();

            useEffect(() => {
                callbackRef.current = callback;
            }, [callback]);

            useEffect(() => {
                if (delay !== null) {
                    const tick = () => {
                        callbackRef.current();
                        timeoutRef.current = setTimeout(tick, delay);
                    };
                    timeoutRef.current = setTimeout(tick, delay);

                    return () => {
                        if (timeoutRef.current) {
                            clearTimeout(timeoutRef.current);
                        }
                    };
                }
            }, [delay]);
        };

        // Car Component
        const Car = ({ x, y }) => {
            return (
                <div
                    style={{
                        position: 'absolute',
                        left: x,
                        top: y,
                        width: 40,
                        height: 60,
                        backgroundColor: 'blue',
                        border: '2px solid darkblue',
                        zIndex: 10
                    }}
                >
                    üöó
                </div>
            );
        };

        // Game Controls Component
        const GameControls = ({
            gameState,
            soundEnabled,
            onPlay,
            onPause,
            onResume,
            onRestart,
            onToggleSound,
        }) => {
            return (
                <div>
                    {gameState === 'menu' ? (
                        <button onClick={onPlay}>
                            ‚ñ∂ Start
                        </button>
                    ) : gameState === 'playing' ? (
                        <button onClick={onPause}>
                            ‚è∏ Pause
                        </button>
                    ) : gameState === 'paused' ? (
                        <button onClick={onResume}>
                            ‚ñ∂ Resume
                        </button>
                    ) : (
                        <button onClick={onPlay}>
                            ‚ñ∂ Start
                        </button>
                    )}

                    <button onClick={onRestart}>
                        üîÑ Restart
                    </button>

                    <button onClick={onToggleSound}>
                        {soundEnabled ? 'üîä' : 'üîá'} Sound
                    </button>
                </div>
            );
        };

        // Main Game Component
        const Game = () => {
            const [gameState, setGameState] = useState('menu');
            const [score, setScore] = useState(0);
            const [highScore, setHighScore] = useState(() => {
                const saved = localStorage.getItem('carGameHighScore');
                return saved ? parseInt(saved, 10) : 0;
            });
            const [soundEnabled, setSoundEnabled] = useState(true);
            const [carPosition, setCarPosition] = useState({ x: 160, y: 400 });
            const [obstacles, setObstacles] = useState([]);
            const [keys, setKeys] = useState(new Set());
            
            const gameAreaRef = useRef();
            const obstacleIdRef = useRef(0);

            const playStartSound = () => {
                if (!soundEnabled) return;
                try {
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(554, audioContext.currentTime + 0.1);
                    oscillator.frequency.setValueAtTime(659, audioContext.currentTime + 0.2);
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.3);
                } catch (e) {
                    console.log('Audio not supported');
                }
            };

            const handleGameOver = useCallback(() => {
                setGameState('gameOver');
                if (score > highScore) {
                    setHighScore(score);
                    localStorage.setItem('carGameHighScore', score.toString());
                }
                if (soundEnabled) {
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const oscillator = audioContext.createOscillator();
                        const gainNode = audioContext.createGain();
                        
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                        oscillator.frequency.exponentialRampToValueAtTime(50, audioContext.currentTime + 0.5);
                        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                        
                        oscillator.start(audioContext.currentTime);
                        oscillator.stop(audioContext.currentTime + 0.5);
                    } catch (e) {
                        console.log('Audio not supported');
                    }
                }
            }, [score, highScore, soundEnabled]);

            const updateGame = useCallback(() => {
                // Move car based on keys
                setCarPosition(prev => {
                    let newX = prev.x;
                    let newY = prev.y;

                    if (keys.has('ArrowLeft') || keys.has('a') || keys.has('A')) {
                        newX = Math.max(10, prev.x - 8);
                    }
                    if (keys.has('ArrowRight') || keys.has('d') || keys.has('D')) {
                        newX = Math.min(310, prev.x + 8);
                    }
                    if (keys.has('ArrowUp') || keys.has('w') || keys.has('W')) {
                        newY = Math.max(10, prev.y - 6);
                    }
                    if (keys.has('ArrowDown') || keys.has('s') || keys.has('S')) {
                        newY = Math.min(460, prev.y + 6);
                    }

                    return { x: newX, y: newY };
                });

                // Move obstacles and generate new ones
                setObstacles(prev => {
                    const updated = prev
                        .map(obstacle => ({
                            ...obstacle,
                            y: obstacle.y + 4 + Math.floor(score / 200)
                        }))
                        .filter(obstacle => obstacle.y < 500);

                    // Add new obstacles randomly
                    if (Math.random() < 0.015 + score / 15000) {
                        updated.push({
                            id: obstacleIdRef.current++,
                            x: Math.random() * 300,
                            y: -50,
                            width: 35 + Math.random() * 15,
                            height: 35 + Math.random() * 15
                        });
                    }

                    return updated;
                });

                // Update score
                setScore(prev => prev + 1);
            }, [keys, score]);

            // Game loop
            useGameLoop(() => {
                if (gameState === 'playing') {
                    updateGame();
                }
            }, gameState === 'playing' ? 16 : null);

            // Check collisions
            useEffect(() => {
                if (gameState !== 'playing') return;

                const carRect = { x: carPosition.x, y: carPosition.y, width: 40, height: 60 };
                
                for (const obstacle of obstacles) {
                    if (
                        carRect.x < obstacle.x + obstacle.width &&
                        carRect.x + carRect.width > obstacle.x &&
                        carRect.y < obstacle.y + obstacle.height &&
                        carRect.y + carRect.height > obstacle.y
                    ) {
                        handleGameOver();
                        return;
                    }
                }
            }, [carPosition, obstacles, gameState, handleGameOver]);

            const startGame = () => {
                setGameState('playing');
                setScore(0);
                setCarPosition({ x: 160, y: 400 });
                setObstacles([]);
                obstacleIdRef.current = 0;
                playStartSound();
            };

            const pauseGame = () => {
                setGameState('paused');
            };

            const resumeGame = () => {
                setGameState('playing');
            };

            const restartGame = () => {
                setGameState('playing');
                setScore(0);
                setCarPosition({ x: 160, y: 400 });
                setObstacles([]);
                obstacleIdRef.current = 0;
                playStartSound();
            };

            const toggleSound = () => {
                setSoundEnabled(!soundEnabled);
            };

            // Keyboard event handlers
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', ' '].includes(e.key)) {
                        e.preventDefault();
                    }
                    setKeys(prev => new Set(prev).add(e.key));
                };

                const handleKeyUp = (e) => {
                    setKeys(prev => {
                        const newKeys = new Set(prev);
                        newKeys.delete(e.key);
                        return newKeys;
                    });
                };

                window.addEventListener('keydown', handleKeyDown);
                window.addEventListener('keyup', handleKeyUp);

                return () => {
                    window.removeEventListener('keydown', handleKeyDown);
                    window.removeEventListener('keyup', handleKeyUp);
                };
            }, []);

            return (
                <div>
                    <div>
                        <h1>üèéÔ∏è Car Racing Game</h1>
                        <div>
                            <span>Score: {score}</span>
                            <span> | High Score: {highScore}</span>
                        </div>
                    </div>

                    {/* Game Area */}
                    <div 
                        ref={gameAreaRef}
                        style={{
                            position: 'relative',
                            width: '320px',
                            height: '400px',
                            border: '2px solid black',
                            backgroundColor: '#333',
                            overflow: 'hidden',
                            margin: '20px auto'
                        }}
                    >
                        {/* Car */}
                        <Car x={carPosition.x} y={carPosition.y} />
                        
                        {/* Obstacles */}
                        {obstacles.map(obstacle => (
                            <div
                                key={obstacle.id}
                                style={{
                                    position: 'absolute',
                                    left: obstacle.x,
                                    top: obstacle.y,
                                    width: obstacle.width,
                                    height: obstacle.height,
                                    backgroundColor: 'red',
                                    border: '1px solid darkred'
                                }}
                            />
                        ))}

                        {/* Game State Overlays */}
                        {gameState === 'menu' && (
                            <div style={{
                                position: 'absolute',
                                top: 0,
                                left: 0,
                                right: 0,
                                bottom: 0,
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                color: 'white',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                flexDirection: 'column'
                            }}>
                                <h2>Ready to Race?</h2>
                                <p>Use arrow keys or WASD to move</p>
                                <button onClick={startGame}>Start Game</button>
                            </div>
                        )}

                        {gameState === 'paused' && (
                            <div style={{
                                position: 'absolute',
                                top: 0,
                                left: 0,
                                right: 0,
                                bottom: 0,
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                color: 'white',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                flexDirection: 'column'
                            }}>
                                <h2>Paused</h2>
                                <button onClick={resumeGame}>Resume</button>
                            </div>
                        )}

                        {gameState === 'gameOver' && (
                            <div style={{
                                position: 'absolute',
                                top: 0,
                                left: 0,
                                right: 0,
                                bottom: 0,
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                color: 'white',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                flexDirection: 'column'
                            }}>
                                <h2>Game Over!</h2>
                                <p>Final Score: {score}</p>
                                {score === highScore && <p>üéâ New High Score!</p>}
                                <button onClick={restartGame}>Play Again</button>
                            </div>
                        )}
                    </div>

                    {/* Game Controls */}
                    <div style={{ textAlign: 'center', margin: '20px' }}>
                        <GameControls
                            gameState={gameState}
                            soundEnabled={soundEnabled}
                            onPlay={startGame}
                            onPause={pauseGame}
                            onResume={resumeGame}
                            onRestart={restartGame}
                            onToggleSound={toggleSound}
                        />
                    </div>

                    <div style={{ textAlign: 'center', fontSize: '12px', color: '#666' }}>
                        <p>Controls: Arrow Keys or WASD ‚Ä¢ Avoid red obstacles!</p>
                    </div>
                </div>
            );
        };

        // Main App Component
        const App = () => {
            return <Game />;
        };

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>